---
import Layout from "../layouts/Layout.astro";
import CharacterCard from "./CharacterCard.astro";
import { getCharacters } from "../data/characters";
import heroGenshin from "../assets/hero-genshin.png";
import anemoIcon from "../assets/elements/anemo.png";
import cryoIcon from "../assets/elements/cryo.png";
import electroIcon from "../assets/elements/electro.png";
import dendroIcon from "../assets/elements/dendro.png";
import geoIcon from "../assets/elements/geo.png";
import hydroIcon from "../assets/elements/hydro.png";
import pyroIcon from "../assets/elements/pyro.png";
import swordIcon from "../assets/weapons/sword.png";
import claymoreIcon from "../assets/weapons/claymore.png";
import polearmIcon from "../assets/weapons/polearm.png";
import bowIcon from "../assets/weapons/bow.png";
import catalystIcon from "../assets/weapons/catalyst.png";
import { t, type Lang } from "../i18n";

interface Props {
	lang: Lang;
}

const { lang } = Astro.props;
const characters = await getCharacters(lang);

const elementFilters = [
	{ value: "all", iconSrc: undefined, label: t(lang, "home.elementAll") },
	{ value: "Anemo", iconSrc: anemoIcon.src, label: t(lang, "home.elementAnemo") },
	{ value: "Cryo", iconSrc: cryoIcon.src, label: t(lang, "home.elementCryo") },
	{ value: "Electro", iconSrc: electroIcon.src, label: t(lang, "home.elementElectro") },
	{ value: "Dendro", iconSrc: dendroIcon.src, label: t(lang, "home.elementDendro") },
	{ value: "Geo", iconSrc: geoIcon.src, label: t(lang, "home.elementGeo") },
	{ value: "Hydro", iconSrc: hydroIcon.src, label: t(lang, "home.elementHydro") },
	{ value: "Pyro", iconSrc: pyroIcon.src, label: t(lang, "home.elementPyro") }
] as const;

const weaponFilters = [
	{ value: "all", iconSrc: undefined, label: t(lang, "home.weaponAll") },
	{ value: "Sword", iconSrc: swordIcon.src, label: "Sword" },
	{ value: "Claymore", iconSrc: claymoreIcon.src, label: "Claymore" },
	{ value: "Polearm", iconSrc: polearmIcon.src, label: "Polearm" },
	{ value: "Bow", iconSrc: bowIcon.src, label: "Bow" },
	{ value: "Catalyst", iconSrc: catalystIcon.src, label: "Catalyst" }
] as const;
---

<Layout title={t(lang, "meta.homeTitle")} lang={lang}>
	<div
		class="relative h-[600px] flex items-center justify-center overflow-hidden"
	>
		<div class="absolute inset-0 z-0">
			<img
				src={heroGenshin.src}
				alt={t(lang, "home.heroAlt")}
				class="w-full h-full object-cover blur-[3px] scale-105 opacity-55"
			/>
			<div
				class="absolute inset-0 bg-gradient-to-b from-slate-950/60 via-slate-900/70 to-slate-900"
			>
			</div>
		</div>

		<div class="relative z-10 text-center px-4 max-w-4xl mx-auto mt-20">
			<h1
				class="text-5xl md:text-7xl font-bold mb-6 text-white drop-shadow-lg tracking-tight"
			>
				{t(lang, "home.heroPrefix")} <span
					class="text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-yellow-500"
					>{t(lang, "home.heroHighlight")}</span
				>
			</h1>
			<p
				class="text-xl md:text-2xl text-slate-200 mb-8 max-w-2xl mx-auto shadow-black drop-shadow-md"
			>
				{t(lang, "home.heroDescription")}
			</p>
			<div class="flex flex-wrap gap-4 justify-center">
				<a
					href="#characters"
					class="bg-yellow-500 hover:bg-yellow-600 text-slate-900 font-bold py-3 px-8 rounded-full transition-all hover:scale-105 shadow-[0_0_20px_rgba(234,179,8,0.5)]"
				>
					{t(lang, "home.ctaCharacters")}
				</a>
				<a
					href="#"
					class="bg-slate-700/80 hover:bg-slate-700 text-white font-bold py-3 px-8 rounded-full transition-all hover:scale-105 border border-slate-600 backdrop-blur-sm"
				>
					{t(lang, "home.ctaMap")}
				</a>
			</div>
		</div>
	</div>

	<section
		id="characters"
		class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20"
	>
		<div class="flex items-center justify-between mb-12">
			<div>
				<h2 class="text-3xl font-bold text-white mb-2">
					{t(lang, "home.sectionTitle")}
				</h2>
				<div class="h-1 w-20 bg-yellow-500 rounded-full"></div>
			</div>
		</div>

		<div class="flex flex-wrap items-center gap-3 mb-8">
			<input
				id="character-search"
				type="search"
				placeholder={t(lang, "home.searchPlaceholder")}
				class="w-full sm:w-64 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-yellow-400/60 focus:border-yellow-400/60"
			/>

			<div class="inline-flex rounded-md shadow-sm" role="group" id="element-filters">
				{elementFilters.map((elementFilter, index) => (
					<button
						type="button"
						data-element-filter={elementFilter.value}
						aria-pressed={elementFilter.value === "all" ? "true" : "false"}
						title={elementFilter.label}
						class={`px-3 py-2 text-sm font-medium border border-slate-600 transition-colors ${index === 0 ? "rounded-l-lg" : ""} ${index === elementFilters.length - 1 ? "rounded-r-lg" : ""} ${elementFilter.value === "all" ? "bg-yellow-500 text-slate-900 hover:bg-yellow-400" : "bg-slate-700 text-white hover:bg-slate-600"}`}
					>
						{elementFilter.iconSrc ? (
							<img src={elementFilter.iconSrc} alt="" aria-hidden="true" class="h-5 w-5" />
						) : (
							<span aria-hidden="true">✦</span>
						)}
						<span class="sr-only">{elementFilter.label}</span>
					</button>
				))}
			</div>

			<div class="inline-flex rounded-md shadow-sm" role="group" id="weapon-filters">
				{weaponFilters.map((weaponFilter, index) => (
					<button
						type="button"
						data-weapon-filter={weaponFilter.value}
						aria-pressed={weaponFilter.value === "all" ? "true" : "false"}
						title={weaponFilter.label}
						class={`px-3 py-2 text-sm font-medium border border-slate-600 transition-colors ${index === 0 ? "rounded-l-lg" : ""} ${index === weaponFilters.length - 1 ? "rounded-r-lg" : ""} ${weaponFilter.value === "all" ? "bg-yellow-500 text-slate-900 hover:bg-yellow-400" : "bg-slate-700 text-white hover:bg-slate-600"}`}
					>
						{weaponFilter.iconSrc ? (
							<img src={weaponFilter.iconSrc} alt="" aria-hidden="true" class="h-5 w-5 object-contain" />
						) : (
							<span aria-hidden="true">✦</span>
						)}
						<span class="sr-only">{weaponFilter.label}</span>
					</button>
				))}
			</div>

			<div class="inline-flex rounded-md shadow-sm" role="group" id="rarity-filters">
				<button
					type="button"
					data-rarity-filter="all"
					aria-pressed="true"
					class="px-4 py-2 text-sm font-medium border border-slate-600 rounded-l-lg transition-colors bg-yellow-500 text-slate-900 hover:bg-yellow-400"
				>
					{t(lang, "home.filterAll")}
				</button>
					<button
						type="button"
						data-rarity-filter="5"
						aria-pressed="false"
						class="px-4 py-2 text-sm font-medium text-white bg-slate-700 border-t border-b border-slate-600 hover:bg-slate-600 transition-colors"
					>
						5★
					</button>
					<button
						type="button"
						data-rarity-filter="4"
						aria-pressed="false"
						class="px-4 py-2 text-sm font-medium text-white bg-slate-700 border border-slate-600 rounded-r-lg hover:bg-slate-600 transition-colors"
					>
						4★
					</button>
			</div>
		</div>

		<div
			id="character-grid"
			class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6"
		>
			{characters.map((char) => (
				<div
					data-character-card
					data-rarity={String(char.rarity)}
					data-elements={(char.elements ?? [char.element]).join("|")}
					data-weapon={char.weapon}
					data-name={char.name}
				>
					<CharacterCard character={char} />
				</div>
			))}
		</div>

		<div class="mt-12 text-center">
			<button
				class="text-slate-400 hover:text-white font-medium border-b border-transparent hover:border-white transition-colors pb-1"
			>
				{t(lang, "home.loadMore")}
			</button>
		</div>
	</section>
</Layout>

<script>
	const filterButtons = Array.from(document.querySelectorAll<HTMLButtonElement>("[data-rarity-filter]"));
	const elementButtons = Array.from(document.querySelectorAll<HTMLButtonElement>("[data-element-filter]"));
	const weaponButtons = Array.from(document.querySelectorAll<HTMLButtonElement>("[data-weapon-filter]"));
	const searchInput = document.querySelector<HTMLInputElement>("#character-search");
	const characterCards = Array.from(document.querySelectorAll<HTMLElement>("[data-character-card]"));
	let activeRarityFilter = "all";
	let activeElementFilter = "all";
	let activeWeaponFilter = "all";
	let activeNameQuery = "";

	const normalizeText = (value: string) =>
		value
			.toLowerCase()
			.normalize("NFD")
			.replace(/[\u0300-\u036f]/g, "");

	const setRarityButtonState = (activeFilter: string) => {
		for (const button of filterButtons) {
			const buttonFilter = button.dataset.rarityFilter ?? "all";
			const isActive = buttonFilter === activeFilter;
			button.setAttribute("aria-pressed", String(isActive));
			button.classList.toggle("bg-yellow-500", isActive);
			button.classList.toggle("text-slate-900", isActive);
			button.classList.toggle("hover:bg-yellow-400", isActive);
			button.classList.toggle("bg-slate-700", !isActive);
			button.classList.toggle("text-white", !isActive);
			button.classList.toggle("hover:bg-slate-600", !isActive);
		}
	};

	const setElementButtonState = (activeFilter: string) => {
		for (const button of elementButtons) {
			const buttonFilter = button.dataset.elementFilter ?? "all";
			const isActive = buttonFilter === activeFilter;
			button.setAttribute("aria-pressed", String(isActive));
			button.classList.toggle("bg-yellow-500", isActive);
			button.classList.toggle("text-slate-900", isActive);
			button.classList.toggle("hover:bg-yellow-400", isActive);
			button.classList.toggle("bg-slate-700", !isActive);
			button.classList.toggle("text-white", !isActive);
			button.classList.toggle("hover:bg-slate-600", !isActive);
		}
	};

	const setWeaponButtonState = (activeFilter: string) => {
		for (const button of weaponButtons) {
			const buttonFilter = button.dataset.weaponFilter ?? "all";
			const isActive = buttonFilter === activeFilter;
			button.setAttribute("aria-pressed", String(isActive));
			button.classList.toggle("bg-yellow-500", isActive);
			button.classList.toggle("text-slate-900", isActive);
			button.classList.toggle("hover:bg-yellow-400", isActive);
			button.classList.toggle("bg-slate-700", !isActive);
			button.classList.toggle("text-white", !isActive);
			button.classList.toggle("hover:bg-slate-600", !isActive);
		}
	};

	const applyFilters = () => {
		for (const card of characterCards) {
			const rarity = card.dataset.rarity;
			const elements = (card.dataset.elements ?? "").split("|").filter(Boolean);
			const weapon = card.dataset.weapon ?? "";
			const name = normalizeText(card.dataset.name ?? "");

			const rarityMatch = activeRarityFilter === "all" || rarity === activeRarityFilter;
			const elementMatch = activeElementFilter === "all" || elements.includes(activeElementFilter);
			const weaponMatch = activeWeaponFilter === "all" || weapon === activeWeaponFilter;
			const nameMatch = !activeNameQuery || name.includes(activeNameQuery);
			const shouldShow = rarityMatch && elementMatch && weaponMatch && nameMatch;
			card.classList.toggle("hidden", !shouldShow);
		}

		setRarityButtonState(activeRarityFilter);
		setElementButtonState(activeElementFilter);
		setWeaponButtonState(activeWeaponFilter);
	};

	for (const button of filterButtons) {
		button.addEventListener("click", () => {
			activeRarityFilter = button.dataset.rarityFilter ?? "all";
			applyFilters();
		});
	}

	for (const button of elementButtons) {
		button.addEventListener("click", () => {
			activeElementFilter = button.dataset.elementFilter ?? "all";
			applyFilters();
		});
	}

	for (const button of weaponButtons) {
		button.addEventListener("click", () => {
			activeWeaponFilter = button.dataset.weaponFilter ?? "all";
			applyFilters();
		});
	}

	searchInput?.addEventListener("input", () => {
		activeNameQuery = normalizeText(searchInput.value.trim());
		applyFilters();
	});
</script>
